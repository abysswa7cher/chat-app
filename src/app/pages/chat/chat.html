<!-- src/app/pages/chat/chat.component.html -->
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-left">
            <h1>Secure Chat</h1>
            <span class="status" [class.connected]="connected">
                {{ connected ? '● Connected' : '○ Disconnected' }}
            </span>
        </div>
        <div class="header-right">
            @if(currentUser.is_admin) {
            <button matButton="filled" (click)="openInviteDialog()">Invite</button>
            }

            <button matButton [matMenuTriggerFor]="menu">About me</button>
            <mat-menu #menu="matMenu">
                <div mat-menu-item id="about-me">
                    <div>Username: {{me()?.username}}</div>
                    <div>Email: {{me()?.email}}</div>
                    <div>Admin: {{me()?.is_admin ? "Yes" : "No"}}</div>
                </div>
            </mat-menu>

            <!-- Salt Input -->
            <mat-form-field appearance="outline" class="salt-field">
                <mat-label>Encryption Salt</mat-label>
                <input matInput [(ngModel)]="userSalt" [type]="saltVisible() ? 'text' : 'password'"
                    placeholder="Enter shared secret" />
                <mat-icon matSuffix (click)="toggleSaltVisibility()">{{ saltVisible() ? 'visibility_off' : 'visibility'
                    }}</mat-icon>
            </mat-form-field>
            <span class="username">{{ currentUser?.username }}</span>
            <button mat-flat-button (click)="logout()">Logout</button>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-container">
        @if (messages.length === 0) {
        <div class="empty-state">
            <p>No messages yet. Start the conversation!</p>
            @if (!userSalt()) {
            <p class="salt-warning">
                ⚠️ Configure your salt above to decrypt messages
            </p>
            }
        </div>
        }

        @for (message of messages; track message.id + $index) {
        <div class="message" [class.own-message]="message.isOwn"
            [class.likely-gibberish]="isLikelyGibberish(message.content)">
            <div class="message-header">
                <span class="message-username">{{ message.username }}</span>
                <span class="message-time">{{ formatTime(message.created_at) }}</span>
            </div>

            @if (!isLikelyGibberish(message.content)) {
            <div class="message-content">{{ message.content }}</div>
            } @else {
            <app-encrypted-message [length]="30" [sweepSpeed]="40" [pauseDuration]="250">
            </app-encrypted-message>
            }
        </div>
        }

        <!-- Input -->
    </div>
    <div class="chat-input">
        <mat-form-field appearance="outline">
            <input matInput [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" placeholder="Type a message..."
                [disabled]="!connected || !userSalt()" />
        </mat-form-field>
        <button matButton="filled" (click)="sendMessage()" [disabled]="!connected || !newMessage.trim() || !userSalt()">
            Send
            <mat-icon>send</mat-icon>
        </button>
    </div>
</div>